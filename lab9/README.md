# 第八章 Course Projects

> 更喜岷山千里雪，三军过后尽开颜。

我们终于来到了本学期实验课的最后一次实验，在本章中，同学们可以从以下项目中选出若干个自己喜欢的项目来实现。

# Project 1 虚拟内存的完善

通过分页机制，我们实现了内存的虚拟化，从而使得程序可以看到比实际的物理内存更大的虚拟内存。虚拟内存另外一个重要的组成部分是页换入换出机制，页换入换出的解释如下。

当内存紧张的时候，我们不得不将一些物理页换出内存，存放到磁盘上，这被称为页的换出。当程序需要使用被换出的页时，程序会产生一个缺页中断。此时，缺页中断处理函数根据页面置换算法将其他某些页换出，然后将程序需要的页从磁盘加载到内存，并修改页表，使得页表重新指向被重新加载到内存的页。这个过程被称为页的换入。

为了简便起见，我们并没有实现页换入换出机制。现在，同学们需要在自己本学期的实验基础上，实现页换入换出机制。在实现了页换入换出机制后，同学们需要自行提供测例来测试页的换出和页的换入。根据测试方法和输出结果来解释自己程序的正确性。最后将结果截图并说说你是怎么做的。

# Project 2 malloc/free的实现

我们已经实现了以页为粒度的动态内存分配和释放。但是，我们在程序中使用的往往是以字节为粒度的动态内存管理机制，即我们可以分配和释放任意字节长度的内存。

在本项目中，同学们需要实现系统调用malloc和free。malloc用于分配任意字节的内存，free用于释放任意字节的内存。在实现了malloc和free后，同学们需要自行提供测例来测试malloc和free。根据测试方法和输出结果来解释自己程序的正确性。最后将结果截图并说说你是怎么做的。

# Project 3 文件系统的实现

我们已经知道，内存是易失的，磁盘是非易失的。有时我们需要将数据从内存持久化到磁盘上。此时，我们需要提供一种结构来有效管理磁盘上的数据，这种结构被称为文件系统。例如，我们将存储到磁盘上的数据称为一个个“文件”、“文件”之间的结构和组成关系被称为“目录”、文件系统提供了“路径”使得我们容易标记磁盘上的文件……总而言之，文件系统大大方便了我们对磁盘上的数据的管理。

在本项目中，同学们可以参考经典的文件系统来设计自己的文件系统，如FAT、NTFS、EXT等，实现基本的文件系统功能。在实现文件系统后，同学们需要自行提供测例来测试malloc和free。根据测试方法和输出结果来解释文件系统的正确性。最后将结果截图并说说你是怎么做的。

# Project 4 Shell的实现

虽然我们已经实现了操作系统的许多基本概念，但是我们的操作系统并不能接受和处理我们的命令。在Linux系统中，我们可以很方便地在Terminal下输入并执行我们的命令，如`cd`、`ls`等，这个用于解释和处理用户命令的Terminal被称为Shell。

现在，同学们需要在本学期自己的实验基础上实现Shell，同学们的Shell应该具有以下基本功能。

+ 实现键盘输入并能够解析和处理用户输入的命令。
+ 在实现Project 3的基础上，实现从文件系统中加载程序到内存、然后解析ELF文件、最后创建进程运行这个程序。

在实现Shell后，同学们需要自行提供测例来测试你的Shell。根据测试方法和输出结果来解释你的Shell的正确性。最后将结果截图并说说你是怎么做的。

# Project 5 CopyOnWrite

在我们的fork实现当中，我们会复制父进程的所有资源到子进程中。这样的做法虽然简单，但是开销较大。注意到如下特点

+ 父进程中有些资源是只读的，并不会做修改。因此任何时刻，父子进程的只读资源都是相同的。因此父子进程的只读资源可以共享。
+ 父进程的有些资源在子进程中可能不会被再次用到，或者是暂时不会被用到。

因此，为了减少资源的开销，我们可以实现copy-on-write（写时复制）机制。在写时复制机制中，fork函数不会为子进程复制任何父进程任何物理页，而是父进程共享相同的物理空间，父子共享的部分被标记为只读的。当父/子进程需要修改共享的内容的时候，会产生一个中断。然后，这个中断处理函数会为子进程分配物理空间，然后将需要修改的数据复制到刚刚为子进程分配的物理空间中。中断处理完成后，父/子进程才会修改刚刚需要的数据。

现在，同学们需要在本学期自己的实验基础上实现基于copy-on-write机制的fork函数。在实现copy-on-write后，同学们需要自行提供测例来测试你的copy-on-write。根据测试方法和输出结果来解释你的copy-on-write的正确性。最后将结果截图并说说你是怎么做的。

# Project 6 另辟蹊径

考虑到同学们可能会有其他的想法，同学们大可天马行空，另辟蹊径。project 6只为同学们提供一些探索思路。

本教程创始于2021年春季中山大学计算机学院操作系统课程，在陈鹏飞老师的统一指导下完成。时间仓促，在本教程中会存在许许多多的意想不到的问题，例如对某些概念解释不清、代码中存在bug、实验安排不不合理等。同时，本教程为了简化，省去了许多本教程认为不是必须的操作系统实现的细节。因此，同学们可以结合自己的实验过程，参考ucore、《操作系统真象还原》、《一个操作系统的实现》等来完善本教程。

本教程使用C/C++和x86汇编来实现。但是，C/C++和x86汇编已有数十年的历史。如今，Rust语言和arm处理器方兴未艾。同学们可以结合rust语言和arm处理器来重构本教程的代码。同学们可以使用rust+x86，C/C++ + arm，rust+arm的方式来实现。

同学们可以考虑你实现的操作系统是否可以在真实的硬件上执行，例如在树莓派中执行、使用U盘在你的电脑上启动等。

本教程是在32位保护模式下实现的，同学们可以探索64位操作系统的实现。

……

